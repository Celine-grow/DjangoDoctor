{% extends 'DoctorApp/base.html' %}
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Cystella{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/cystella.css' %}">
</head>
{% block extra_css %}
<style>
    .form-container {
        background-color: #fff;
        padding: 30px;
        margin: auto;
        max-width: 600px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .form-container h2 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 20px;
    }

    label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
        color: #333;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 20px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        background-color: #fafafa;
    }

    textarea {
        resize: vertical;
    }

    .button-row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }

    .button-row input[type="button"],
    .button-row input[type="submit"] {
        flex: 1;
        padding: 10px;
        font-size: 16px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .button-row input[type="button"]:hover,
    .button-row input[type="submit"]:hover {
        background-color: #2980b9;
    }

    .form-container p {
        text-align: center;
        margin-top: 20px;
        color: green;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<form method="POST" class="form-container" onsubmit="event.preventDefault();">
    {% csrf_token %}
    <h2>Patient Details Info</h2>

    <label>Patient's Name:</label><br>
    <input type="text" name="name" id="name"><br><br>

    <label>Age of patient:</label><br>
    <input type="number" name="age" id="age"><br><br>

    <label>Cyst size in cm:</label><br>
    <input type="number" name="cystsize" id="cystsize"><br><br>

    <label>Menopause status:</label><br>
    <select name="menopause_status" id="menopause_status">
        <option value="">--Select--</option>
        <option value="Postmenopause">Postmenopause</option>
        <option value="Premenopause">Premenopause</option>
    </select><br><br>

    <label>CA 125 levels:</label><br>
    <input type="number" name="ca_levels" id="ca_levels"><br><br>

    <label>Ultrasound features:</label><br>
    <select name="Ultrasound_features" id="ultrasound">
        <option value="">--Select--</option>
        <option value="Solid_mass">Solid mass</option>
        <option value="Simple_Cyst">Simple Cyst</option>
        <option value="Complex_Cyst">Complex Cyst</option>
        <option value="Septated_Cyst">Septated Cyst</option>
        <option value="Hemorrhagic_Cyst">Hemorrhagic Cyst</option>
    </select><br><br>

    <label>Reported Symptoms:</label><br>
    <textarea name="description" id="description" rows="5" cols="40"
        placeholder="Write something..."></textarea><br><br>

    <label>Region:</label><br>
    <select name="region" id="region">
        <option value="">--Select Region--</option>
        <option value="Eldoret">Eldoret</option>
        <option value="Loitoktok">Loitoktok</option>
        <option value="Mombasa">Mombasa</option>
        <option value="Nairobi">Nairobi</option>
        <option value="Kisumu">Kisumu</option>
        <option value="Machakos">Machakos</option>
        <option value="Embu">Embu</option>
        <option value="Nakuru">Nakuru</option>
        <option value="Moi">Moi</option>
        <option value="Pumwani">Pumwani</option>
        <option value="Garrisa">Garrisa</option>
        <option value="Kitale">Kitale</option>
        <option value="Kakamega">Kakamega</option>
        <option value="Kericho">Kericho</option>
    </select><br><br>

    <div class="button-row">
        <input type="button" value="Predict" onclick="predictGrowthRate()">
        <input type="button" onclick="generateReport()" value="Generate Treatment Report">
        <input type="submit" value="Inventory">
    </div>
</form>

{% if submitted %}
<p class="form-container p">Thank you, {{ name }}! We received your submission.</p>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    async function predictGrowthRate() {
        const payload = {
            name: document.getElementById('name').value,
            age: parseInt(document.getElementById('age').value),
            size: parseFloat(document.getElementById('cystsize').value),
            ca125: parseFloat(document.getElementById('ca_levels').value),
            menopause: document.getElementById('menopause_status').value,
            ultrasound: document.getElementById('ultrasound').value,
            symptoms: document.getElementById('description').value,
            region: document.getElementById('region').value,
            management: "awaiting"
        };
        console.log('üì§ Sending payload:', payload);

        const response = await fetch("http://localhost:8000/predict/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

             if (response.ok) {
            const data = await response.json();
            const { jsPDF } = window.jspdf || globalThis.jspdf;
            const doc = new jsPDF();

            // ‚úÖ Pink strip at the top
            doc.setFillColor(255, 192, 203); // light pink
            doc.rect(0, 0, 210, 20, 'F'); // full width pink strip

            // ‚úÖ Title on top of pink strip
            doc.setTextColor(40, 40, 40);
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text("Ovarian Cyst Growth Prediction Report", 20, 15);

            doc.setTextColor(0, 0, 0); // Reset to black
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");

            let y = 30;

            const lines = [
                `This report is generated for patient: ${payload.name}.`,
                `The patient is ${payload.age} years old with a cyst size of ${payload.size} cm.`,
                `CA-125 level measured: ${payload.ca125}.`,
                `Menopause status is: ${payload.menopause}, and ultrasound results indicate: ${payload.ultrasound}.`,
                `Reported symptoms: ${payload.symptoms}.`,
                `Region of examination: ${payload.region}.`,
                `----------------------------------------`,
                `Predicted cyst growth rate: ${data.prediction} cm/day.`,
                `Based on this rate, the system classifies the growth as: ${data.category}.`,
                `Recommended medical action: ${data.recommended_management}.`,
                `----------------------------------------`,
                `Please consult a healthcare professional for further evaluation.`
            ];

            lines.forEach(line => {
                doc.text(line, 20, y);
                y += 10;
            });

                    const filename = `cyst_prediction_${payload.name.replace(/\s/g, "_")}.pdf`;
                    doc.save(filename);
                }


            const filename = `cyst_prediction_${payload.name.replace(/\s/g, "_")}.pdf`;
            doc.save(filename);
        } else {
            const errorText = await response.text();
            alert("‚ùå Error: " + errorText);
        }
    }
</script>
{% endblock %}
