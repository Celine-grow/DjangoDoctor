{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cystella - Ask Cystella AI</title>
    <link rel="stylesheet" href="{% static 'css/ai.css' %}">
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <div class="logo-icon">C</div>
                <span class="logo-text">Cystella</span>
            </div>
           <ul class="nav-menu">
                <li class="nav-item">
                    <a href="{% url 'dashboard' %}" class="nav-link active">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'patients' %}" class="nav-link">Patients</a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'chat' %}" class="nav-link">Chat</a>
                </li>
                 <li class="nav-item">
                    <a href="{% url 'cystela' %}" class="nav-link">Ask Cystella</a>
                </li>
                 <li class="nav-item">
                    <a href="{% url 'settings' %}" class="nav-link">Settings</a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <h1>Ask Cystella AI</h1>
                <div class="date">June 9, 2025</div>
            </div>

            <!-- AI Chat Content Container -->
            <div class="content-container">
                <!-- AI Chat History Section -->
                <div class="chat-history-section">
                    <div class="section-header">
                        <h3>Recent Conversations</h3>
                        <button class="new-conversation-btn" onclick="startNewConversation()">+ New Chat</button>
                    </div>
                    
                    <div class="history-container">
                        <div class="history-item active" onclick="selectConversation('conv1')">
                            <div class="history-icon">ü©∫</div>
                            <div class="history-info">
                                <div class="history-title">Ovarian Cancer Treatment</div>
                                <div class="history-preview">Stage 4 treatment options...</div>
                                <div class="history-time">2 hours ago</div>
                            </div>
                        </div>
                        
                        <div class="history-item" onclick="selectConversation('conv2')">
                            <div class="history-icon">üíä</div>
                            <div class="history-info">
                                <div class="history-title">Medication Interactions</div>
                                <div class="history-preview">Drug interaction analysis...</div>
                                <div class="history-time">Yesterday</div>
                            </div>
                        </div>
                        
                        <div class="history-item" onclick="selectConversation('conv3')">
                            <div class="history-icon">üî¨</div>
                            <div class="history-info">
                                <div class="history-title">Lab Results Analysis</div>
                                <div class="history-preview">CA-125 levels interpretation...</div>
                                <div class="history-time">2 days ago</div>
                            </div>
                        </div>
                        
                        <div class="history-item" onclick="selectConversation('conv4')">
                            <div class="history-icon">üìä</div>
                            <div class="history-info">
                                <div class="history-title">Diagnostic Imaging</div>
                                <div class="history-preview">CT scan findings review...</div>
                                <div class="history-time">3 days ago</div>
                            </div>
                        </div>

                        <div class="history-item" onclick="selectConversation('conv5')">
                            <div class="history-icon">üß¨</div>
                            <div class="history-info">
                                <div class="history-title">Genetic Testing</div>
                                <div class="history-preview">BRCA mutation counseling...</div>
                                <div class="history-time">1 week ago</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Chat Interface Section -->
                <div class="ai-chat-section">
                    <!-- AI Header -->
                    <div class="ai-header">
                        <div class="ai-info">
                            <div class="ai-avatar">
                                <div class="ai-icon">ü§ñ</div>
                                <div class="ai-status-indicator"></div>
                            </div>
                            <div class="ai-details">
                                <div class="ai-name">Cystella AI Assistant</div>
                                <div class="ai-status">Ready to help with medical insights</div>
                            </div>
                        </div>
                        <div class="ai-actions">
                            <button class="ai-action-btn" title="Export Conversation" onclick="exportConversation()">üìÑ</button>
                            <button class="ai-action-btn" title="Share with Team" onclick="shareConversation()">üë•</button>
                            <button class="ai-action-btn" title="Settings" onclick="openSettings()">‚öôÔ∏è</button>
                        </div>
                    </div>

                    <!-- Welcome Screen / Messages Container -->
                    <div class="ai-messages-container" id="aiMessagesContainer">
                        <!-- Welcome Screen -->
                        <div class="welcome-screen" id="welcomeScreen">
                            <div class="welcome-content">
                                <div class="welcome-icon">ü§ñ</div>
                                <h2>Welcome to Cystella AI</h2>
                                <p>Your intelligent medical assistant for gynecological care</p>
                                
                                <div class="capabilities-grid">
                                    <div class="capability-card" onclick="useTemplate('diagnosis')">
                                        <div class="capability-icon">ü©∫</div>
                                        <div class="capability-title">Diagnosis Support</div>
                                        <div class="capability-desc">Get insights on symptoms and conditions</div>
                                    </div>
                                    
                                    <div class="capability-card" onclick="useTemplate('treatment')">
                                        <div class="capability-icon">üíä</div>
                                        <div class="capability-title">Treatment Plans</div>
                                        <div class="capability-desc">Evidence-based treatment recommendations</div>
                                    </div>
                                    
                                    <div class="capability-card" onclick="useTemplate('lab')">
                                        <div class="capability-icon">üî¨</div>
                                        <div class="capability-title">Lab Analysis</div>
                                        <div class="capability-desc">Interpret test results and values</div>
                                    </div>
                                    
                                    <div class="capability-card" onclick="useTemplate('research')">
                                        <div class="capability-icon">üìö</div>
                                        <div class="capability-title">Research Insights</div>
                                        <div class="capability-desc">Latest medical research and studies</div>
                                    </div>
                                </div>

                                <div class="quick-prompts">
                                    <h4>Quick Start Prompts:</h4>
                                    <div class="prompt-buttons">
                                        <button class="prompt-btn" onclick="usePrompt('What are the latest treatment options for stage 3 ovarian cancer?')">
                                            Treatment Options
                                        </button>
                                        <button class="prompt-btn" onclick="usePrompt('Explain the significance of elevated CA-125 levels in a 45-year-old patient.')">
                                            Lab Interpretation
                                        </button>
                                        <button class="prompt-btn" onclick="usePrompt('What are the risk factors for endometrial cancer?')">
                                            Risk Assessment
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Messages will be dynamically added here -->
                    </div>

                    <!-- AI Input Section -->
                    <div class="ai-input-section">
                        <div class="patient-context-bar" id="patientContextBar" style="display: none;">
                            <div class="context-info">
                                <span class="context-icon">üë§</span>
                                <span class="context-text">Context: Sarah Johnson - Stage 2 Ovarian Cancer</span>
                            </div>
                            <button class="context-close" onclick="clearContext()">&times;</button>
                        </div>
                        
                        <div class="ai-input-wrapper">
                            <button class="attachment-btn" title="Attach File" onclick="attachFile()">üìé</button>
                            <button class="voice-btn" title="Voice Input" onclick="toggleVoiceInput()">üé§</button>
                            <textarea 
                                id="aiMessageInput" 
                                placeholder="Ask Cystella AI about medical conditions, treatments, or patient care..."
                                class="ai-message-input"
                                rows="1"
                            ></textarea>
                            <button class="ai-send-btn" onclick="sendAIMessage()" title="Send Message">
                                <span class="send-icon">‚û§</span>
                            </button>
                        </div>
                        
                        <div class="input-footer">
                            <div class="disclaimer">
                                <span class="disclaimer-icon">‚ö†Ô∏è</span>
                                AI responses are for informational purposes only. Always verify with current medical guidelines.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentConversation = 'conv1';
        let isWelcomeScreen = true;

        // Navigation functionality
        function showPage(pageName) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            const headerTitle = document.querySelector('.header h1');
            const pageNames = {
                'dashboard': 'Dashboard',
                'patients': 'Patients',
                'calendar': 'Calendar',
                'notifications': 'Notifications',
                'chat': 'Chat',
                'ai-assistant': 'Ask Cystella AI'
            };
            
            headerTitle.textContent = pageNames[pageName] || 'Ask Cystella AI';
            
            if (pageName !== 'ai-assistant') {
                alert(`Navigating to ${pageNames[pageName]} page`);
            }
        }

        // Conversation management
        function selectConversation(convId) {
            document.querySelectorAll('.history-item').forEach(item => {
                item.classList.remove('active');
            });
            
            event.currentTarget.classList.add('active');
            currentConversation = convId;
            
            // Load conversation history
            loadConversationHistory(convId);
        }

        function startNewConversation() {
            // Clear active conversation
            document.querySelectorAll('.history-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show welcome screen
            showWelcomeScreen();
            currentConversation = null;
        }

        function loadConversationHistory(convId) {
            const messagesContainer = document.getElementById('aiMessagesContainer');
            const welcomeScreen = document.getElementById('welcomeScreen');
            
            // Hide welcome screen
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }
            
            // Clear existing messages
            messagesContainer.innerHTML = '';
            
            // Sample conversation data
            const conversations = {
                'conv1': [
                    { type: 'user', text: 'What are the treatment options for stage 4 ovarian cancer?' },
                    { type: 'ai', text: 'For stage 4 ovarian cancer, treatment typically involves a multimodal approach:\n\n1. **Primary Treatment Options:**\n   - Neoadjuvant chemotherapy followed by interval debulking surgery\n   - Primary debulking surgery followed by adjuvant chemotherapy\n\n2. **Chemotherapy Regimens:**\n   - Carboplatin + Paclitaxel (standard first-line)\n   - Consider adding Bevacizumab for selected patients\n   - PARP inhibitors for BRCA-positive patients\n\n3. **Surgical Considerations:**\n   - Optimal cytoreduction when feasible\n   - Assessment of resectability score\n\nWould you like me to elaborate on any specific aspect of the treatment plan?' }
                ],
                'conv2': [
                    { type: 'user', text: 'Check for interactions between Carboplatin and Warfarin' },
                    { type: 'ai', text: 'There is a **moderate interaction** between Carboplatin and Warfarin:\n\n**Interaction Details:**\n- Carboplatin may enhance the anticoagulant effect of Warfarin\n- Risk of increased bleeding\n- Mechanism: Possible displacement of protein binding\n\n**Clinical Recommendations:**\n- Monitor INR more frequently during concurrent use\n- Consider dose adjustment of Warfarin if needed\n- Watch for signs of bleeding\n- Baseline and periodic CBC monitoring\n\n**Monitoring Schedule:**\n- Check INR within 3-5 days of starting Carboplatin\n- Weekly INR monitoring during treatment\n- Adjust Warfarin dose as clinically indicated' }
                ]
            };
            
            const messages = conversations[convId] || [];
            messages.forEach(message => {
                addAIMessage(message.type, message.text, false);
            });
            
            isWelcomeScreen = false;
        }

        function showWelcomeScreen() {
            const messagesContainer = document.getElementById('aiMessagesContainer');
            messagesContainer.innerHTML = `
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-content">
                        <div class="welcome-icon">ü§ñ</div>
                        <h2>Welcome to Cystella AI</h2>
                        <p>Your intelligent medical assistant for gynecological care</p>
                        
                        <div class="capabilities-grid">
                            <div class="capability-card" onclick="useTemplate('diagnosis')">
                                <div class="capability-icon">ü©∫</div>
                                <div class="capability-title">Diagnosis Support</div>
                                <div class="capability-desc">Get insights on symptoms and conditions</div>
                            </div>
                            
                            <div class="capability-card" onclick="useTemplate('treatment')">
                                <div class="capability-icon">üíä</div>
                                <div class="capability-title">Treatment Plans</div>
                                <div class="capability-desc">Evidence-based treatment recommendations</div>
                            </div>
                            
                            <div class="capability-card" onclick="useTemplate('lab')">
                                <div class="capability-icon">üî¨</div>
                                <div class="capability-title">Lab Analysis</div>
                                <div class="capability-desc">Interpret test results and values</div>
                            </div>
                            
                            <div class="capability-card" onclick="useTemplate('research')">
                                <div class="capability-icon">üìö</div>
                                <div class="capability-title">Research Insights</div>
                                <div class="capability-desc">Latest medical research and studies</div>
                            </div>
                        </div>

                        <div class="quick-prompts">
                            <h4>Quick Start Prompts:</h4>
                            <div class="prompt-buttons">
                                <button class="prompt-btn" onclick="usePrompt('What are the latest treatment options for stage 3 ovarian cancer?')">
                                    Treatment Options
                                </button>
                                <button class="prompt-btn" onclick="usePrompt('Explain the significance of elevated CA-125 levels in a 45-year-old patient.')">
                                    Lab Interpretation
                                </button>
                                <button class="prompt-btn" onclick="usePrompt('What are the risk factors for endometrial cancer?')">
                                    Risk Assessment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            isWelcomeScreen = true;
        }

        // Template and prompt functions
        function useTemplate(type) {
            const templates = {
                'diagnosis': 'Help me analyze symptoms for a patient presenting with: ',
                'treatment': 'What are the current treatment guidelines for: ',
                'lab': 'Please interpret these lab results: ',
                'research': 'What does recent research say about: '
            };
            
            const input = document.getElementById('aiMessageInput');
            input.value = templates[type];
            input.focus();
            hideWelcomeScreen();
        }

        function usePrompt(prompt) {
            const input = document.getElementById('aiMessageInput');
            input.value = prompt;
            hideWelcomeScreen();
            sendAIMessage();
        }

        function hideWelcomeScreen() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }
            isWelcomeScreen = false;
        }

        // AI Message handling
        function sendAIMessage() {
            const input = document.getElementById('aiMessageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Hide welcome screen if visible
            hideWelcomeScreen();
            
            // Add user message
            addAIMessage('user', message);
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Simulate AI response
            setTimeout(() => {
                hideTypingIndicator();
                const aiResponse = generateAIResponse(message);
                addAIMessage('ai', aiResponse);
            }, 2000);
        }

        function addAIMessage(type, text, scroll = true) {
            const messagesContainer = document.getElementById('aiMessagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${type}`;
            
            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            if (type === 'ai') {
                messageDiv.innerHTML = `
                    <div class="ai-message-avatar">
                        <div class="ai-icon">ü§ñ</div>
                    </div>
                    <div class="ai-message-content">
                        <div class="ai-message-text">${formatAIResponse(text)}</div>
                        <div class="ai-message-actions">
                            <button class="message-action-btn" onclick="copyMessage(this)" title="Copy">üìã</button>
                            <button class="message-action-btn" onclick="shareMessage(this)" title="Share">üì§</button>
                            <button class="message-action-btn" onclick="saveMessage(this)" title="Save">üíæ</button>
                        </div>
                        <div class="ai-message-time">${currentTime}</div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="ai-message-content">
                        <div class="ai-message-text">${text}</div>
                        <div class="ai-message-time">${currentTime}</div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            
            if (scroll) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function formatAIResponse(text) {
            // Convert markdown-like formatting to HTML
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        function generateAIResponse(userMessage) {
            // Simple AI response simulation
            const responses = [
                "Based on current medical guidelines, I can provide the following insights:\n\n**Key Points:**\n- Evidence-based recommendations\n- Consider patient-specific factors\n- Monitor for contraindications\n\nWould you like me to elaborate on any specific aspect?",
                "Here's what the latest research indicates:\n\n**Clinical Findings:**\n- Recent studies show promising results\n- Important considerations for patient care\n- Recommended monitoring protocols\n\nI can provide more detailed information if needed.",
                "From a clinical perspective:\n\n**Assessment:**\n- Comprehensive evaluation recommended\n- Multiple factors to consider\n- Evidence-based approach suggested\n\n**Next Steps:**\n- Further diagnostic workup\n- Multidisciplinary consultation\n- Patient education and counseling"
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('aiMessagesContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-message ai typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="ai-message-avatar">
                    <div class="ai-icon">ü§ñ</div>
                </div>
                <div class="ai-message-content">
                    <div class="typing-animation">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Utility functions
        function attachFile() {
            alert('File attachment feature - would integrate with file upload system');
        }

        function toggleVoiceInput() {
            alert('Voice input feature - would integrate with speech recognition');
        }

        function exportConversation() {
            alert('Export conversation feature - would generate PDF or text file');
        }

        function shareConversation() {
            alert('Share conversation feature - would share with team members');
        }

        function openSettings() {
            alert('AI Settings - would open configuration panel');
        }

        function clearContext() {
            document.getElementById('patientContextBar').style.display = 'none';
        }

        function copyMessage(button) {
            const messageText = button.closest('.ai-message-content').querySelector('.ai-message-text').textContent;
            navigator.clipboard.writeText(messageText);
            
            // Visual feedback
            const originalText = button.innerHTML;
            button.innerHTML = '‚úì';
            setTimeout(() => {
                button.innerHTML = originalText;
            }, 1000);
        }

        function shareMessage(button) {
            alert('Share message feature - would share specific message');
        }

        function saveMessage(button) {
            alert('Save message feature - would save to knowledge base');
        }

        // Auto-resize textarea
        document.getElementById('aiMessageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Enter key to send message (Shift+Enter for new line)
        document.getElementById('aiMessageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAIMessage();
            }
        });

        // Demo: Show patient context after 3 seconds
        setTimeout(() => {
            document.getElementById('patientContextBar').style.display = 'flex';
        }, 3000);
    </script>
</body>
</html>
